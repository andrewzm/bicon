---
title: "Causal Spatial Models"
author: "Andrew Zammit Mangion"
date: "28 February 2015"
output: beamer_presentation
fig_width: 7
fig_height: 6
fig_caption: true
bibliography: ../../vignettes/Bibliography.bib
header-includes: 
    - \usepackage{natbib}
    - \usepackage{tikz}
csl: ../../vignettes/apa.csl
Extension: raw_tex
---


$$
\newcommand{\Yt}{\widetilde{Y}}                     
\newcommand{\Deltab} {\boldsymbol{\Delta}}
\newcommand{\intd} {\mathrm{d}}                 
\newcommand{\Bmat} {\textbf{B}}                 
\newcommand{\Cmat} {\textbf{C}}                 
\newcommand{\cmat} {\textbf{c}}                 
\newcommand{\Imat} {\textbf{I}}                 
\newcommand{\bvec} {\textbf{b}}                 
\newcommand{\svec} {\textbf{s}}                 
\newcommand{\uvec} {\textbf{u}}                 
\newcommand{\omegab} {\boldsymbol {\omega}}     
\newcommand{\s}{\mathbf{s}}                     
\newcommand{\h}{\mathbf{h}}                     
\renewcommand{\b}{\mathbf{b}}                   
\newcommand{\z}{\mathbf{z}}                     
\renewcommand{\v}{\mathbf{v}}                   
\renewcommand{\u}{\mathbf{u}}                   
\newcommand{\w}{\mathbf{w}}                     
\renewcommand{\d}{\mathrm{d}}                   
\newcommand{\Z}{\mathbf{Z}}                     
\newcommand{\x}{\mathbf{x}}                   
\newcommand{\Y}{\mathbf{Y}}                     
\newcommand{\Yvec}{\mathbf{Y}}                  
\newcommand{\Zvec}{\mathbf{Z}}                  
\newcommand{\epsilonb}{\boldsymbol{\varepsilon}}
\newcommand{\bI}{\mathbf{I}}                    
\newcommand{\bB}{\mathbf{B}}                    
\newcommand{\bbeta}{\boldsymbol{\beta}}         
\newcommand{\bzero}{\boldsymbol{0}}             
\newcommand{\bSigma}{\bm{\Sigma}}               
\newcommand{\E}{E}                              
\newcommand{\cov}{\mathrm{cov}}                 
\newcommand{\var}{\mathrm{var}}                 
\newcommand{\tr}{\mathrm{tr}}                   
\newcommand{\diag}{\mathrm{diag}}               
\newcommand{\vect}{\mathrm{vec}}                
\newcommand{\Gau}{\mathrm{Gau}}                 
\newcommand{\RR}{\mathbb{R}}     
$$

# Introduction

## Introduction

- **Univariate** spatial models

- **Multivariate** spatial models
    - Two or more interacting spatial variates
    - Improve prediction on one of the variates by observing the others: **Cokriging**
    - Determine which variate caused the observed phenomenon: **Source separation**

## Example 1: Ozone vs MaxT

</br>

- @RoyleBerliner1999, Midwestern USA.

<div class="centered">
<img src="ozone.png" width="380px" />
<img src="maxt.png" width="370px" />
</div>

## Example 2: Antarctica Mass Balance

<img src='Antarctica.png' height="550px" />

## Example 2: Antarctica Mass Balance {.smaller}

<div class="centered">
<img src='Obs.png' height="400px" />
</div>

- @Zammit_2014
- @Zammit_2015a
- @Zammit_2015b

##The challenge

</br>

- **Modelling**: Given a bivariate process $(Y_1(\cdot), Y_2(\cdot))$, what is a valid *cross-covariance function matrix* (CCFM)
  
  $$
  \left(\begin{array}{cc} C_{11}(\cdot,\cdot) & C_{12}(\cdot,\cdot) \\ C_{21}(\cdot,\cdot) & C_{22}(\cdot,\cdot)\end{array} \right)
  $$
  
  such that *any* covariance matrix derived from it is positive-definite?

- **Computational**: Sometimes we struggle with univariate models -- how do we scale up?

##Current approaches

<small>
- **Linear Model of co-regionalisation** (Wackernagel, 1993): Define
  
  $$
  \begin{align}
    Y_1(\cdot) &= a_{11}\Yt_1(\cdot) + a_{12}\Yt_2(\cdot),\\
    Y_2(\cdot) &= a_{21}\Yt_1(\cdot) + a_{22}\Yt_2(\cdot). 
  \end{align}
  $$
  
  where
  
  $$
  \begin{align}
    \Yt_1(\cdot) &\sim (\mu_1(\cdot), C_{1}(\cdot,\cdot)),\\
    \Yt_2(\cdot) &\sim (\mu_2(\cdot), C_{2}(\cdot,\cdot)).
  \end{align}
  $$
  
  - $C_{ij}(\cdot,\cdot) = a_{i1}a_{j1}C_{1}(\cdot,\cdot) + a_{i2}a_{j2}C_{2}(\cdot,\cdot)$.
  
  - CCFM is positive definite for any $\{a_{ij}: i,j = 1,\dots,2\}$. 

</small>

##Current approaches

<small>

- **Bivariate parsimonious Matérn model** [@Gneitingetal2010]: Let $C^o(\cdot)$ be a stationary, isotropic covariance function. Define
  
  $$
  \begin{align}
    C_{ii}^o(\cdot) \equiv M(\cdot; \nu_i, \kappa_i)
    C_{ij}^o(\cdot) \beta_{ij}\equiv M(\cdot; \nu_{ij}, \kappa_{ij})
  \end{align}
  $$
  
  where $M(\cdot)$ is a Matérn covariance function. If we let $\kappa_i = \kappa_{ij} = \kappa$ and set $\nu_{ij} = (\nu_i + \nu_j)/2$ then if
  $(\beta_{ij},i,j = 1,2)'$ is positive definite, the CCFM is positive definite.
  
- **Bivariate full Matérn model**:  Relaxes assumptions on smoothness and scales, but finding eligible values is much more involved.
  
  </small>
  
##Current approaches (Limitations)

</br>


- Stuck with homogeneous models (e.g. convolution methods)
</br>

- Stuck with fixed scales (parsimonious Matérn)
</br>

- Stuck with Matérn models (e.g. full Matérn models)
</br>

- **Stuck with symmetry (e.g. LMC)**

##Asymmetry

<small>
$Y_1(\cdot)$: rain now        
$Y_2(\cdot)$: rain in 5 minutes time

</small>

<div class="centered">
![alt text](rain.jpg)
</div>

# Causal spatial models

##Causal spatial models
</br>
$$
\begin{align}\label{eqn:E-and-cov}                                                          \E\left(Y_2(\s)\mid Y_1(\cdot)\right)&\,=\int_D{b(\s,\v)Y_1(\v)\,\d \v};\quad \s\in D,\\   
&\\
&\\
\cov\left(Y_2(\s),Y_2(\u)\mid Y_1(\cdot)\right)&\,=C_{2\mid 1}(\s,\u);\quad \s,\u\in \mathbb{R}^d.\nonumber                                                                      \end{align}   
$$


Building blocks:

  - $C_{11}(\cdot,\cdot)$
  - $C_{2|1}(\cdot,\cdot)$
  - $b(\cdot,\cdot)$ (interaction function)

##Properties of causal spatial models

-  CCFM is easy to find:

$$
\begin{bmatrix} C_{11}(\s,\u) & \int_DC_{11}(\s,\v)b(\u,\v)\d\v \\ \int_Db(\s,\v)C_{11}(\v,\u)\d\v & ~~~~~C_{22}(\s,\u)\end{bmatrix};                     $$
$$
\small
C_{22}(\s,\u) = C_{2\mid 1}(\s,\u)+\int_D\int_D b(\s,\v)C_{11}(\v,\w)b(\w,\u)\d\v\d\w 
$$

and is always valid (proof to appear).

- Asymmetry is guaranteed if $b(\cdot,\cdot)$ is not symmetric

##Properties of causal spatial models

- Assume $b^o(\cdot) = b(\cdot,\cdot)$ and that it is off-centre
- $\s,\u \in \{-1, -0.9 ,\dots, 1\}$

<div class="centered">
<img src="./Sigma.png" width="400px" />
</div>

## Properties of causal spatial models {.build}

</br>

- Heterogeneity since $C_{11}(\cdot,\cdot)$, $C_{2|1}(\cdot,\cdot)$ need not be heterogeneous and $b(\svec,\uvec)$ need not be symmetric.

</br>

- We are not restricted to Matérn fields. The bivariate parsimonious Matérn field is a **special case**.

</br>

- $Y_2(\cdot)$ can be arbitrarily smoother than $Y_1(\cdot)$ *and* have a different scale.

</br>

  
## Example

</br>
  
- Assume all parameters are known and $Y_1(\cdot)$ is only partially observed.



- Use simple cokriging kriging **or** simple kriging to estimate $Y_1(\cdot)$:

$$
\begin{align}
\hat Y_1(\svec_0) &\equiv \E(Y_1(\svec_0) \mid  \Zvec_1, \Zvec_2) \\
\widetilde Y_1(\svec_0) &\equiv \E(Y_1(\svec_0) \mid  \Zvec_1)
\end{align}
$$

## Example

<div class="centered">
<img src="./sim_obs.png" width="700px" />
</div>

## Example

<div class="centered">
<img src="./sim_est.png" width="700px" />
</div>


## Is the bivariate model always valid? {.build .smaller}


- If $C_{11}(\svec,\uvec)$ and $C_{2|1}(\svec,\uvec)$ is positive definite, then $C_{22}(\cdot,\cdot)$ is positive definite.
- $C_{12}(\svec,\uvec) = C_{21}(\uvec,\svec)$
- CCFM is positive definite
$$
\begin{align}                                                                                                   J_2 &= \var\left(\sum_{k=1}^{n_1}{a_{1k}Y_1^0(\s_{1k})}+\sum_{l=1}^{n_2}{a_{2l}Y_2^0(\s_{2l})}\right) \\ &=\sum_{k=1}^{n_1}\sum_{k'=1}^{n_1} a_{1k}a_{1k'}C_{11}^0(\s_{1k},\s_{1k'})+\sum_{l=1}^{n_2}\sum_{l'=1}^{n_2} a_{2l}a_{2l'}C_{22}^0(\s_{2l},\s_{2l'}) \\
  &+\sum_{k=1}^{n_1}\sum_{l'=1}^{n_2} a_{1k}a_{2l'}C_{12}^0(\s_{1k},\s_{2l'})+\sum_{l=1}^{n_2}\sum_{k'=1}^{n_1} a_{2l}a_{1k'}C_{21}^0(\s_{2l},\s_{1k'})~ \ge 0.
\end{align}
$$

## Is the bivariate model always valid? {.build}

<small>
</br>

$$
\begin{align}
J_2 &= \var\left(\sum_{k=1}^{n_1}{a_{1k}Y_1^0(\s_{1k})}+\sum_{l=1}^{n_2}{a_{2l}Y_2^0(\s_{2l})}\right)\\
&= \sum_{l=1}^{n_2}\sum_{l'=1}^{n_2}a_{2l}a_{2l'}C_{2\mid 1}(\s_{2l},\s_{2l'})+\int_D \int_D{a(\s)a(\u)C_{11}(\s,\u)\,\d\s\d\u},
\end{align}
$$

where

$$                                                                                             
a(\s)\equiv \sum_{k=1}^{n_1}a_{1k}\delta(\s-\s_{1k})+\sum_{l=1}^{n_2}a_{2l}b(\s_{2l},\s);\quad \s\in \RR^d,     $$
</small>

## Beyond two dimensions {.build}

<small>

-  $[Y_1(\cdot),\dots,Y_p(\cdot)]$ can be decomposed as,
$$
[Y_p(\cdot) \mid  Y_{p-1}(\cdot),Y_{p-2}(\cdot),\dots,Y_1(\cdot)]\dots [Y_1(\cdot)].                            $$

- Analogous to the bivariate case $p=2$,

$$
\begin{align}
\E(Y_q(\svec) \mid  \{Y_r(\cdot) : r = 1,\dots,(q-1)\}) \\
= \sum_{r = 1}^{q-1} \int_D b_{qr}(\svec,\v)Y_r(\v) \intd \v; \quad \svec \in D,\\
\cov(Y_q(\svec), Y_q(\uvec) \mid  \{Y_r(\cdot) : r = 1,\dots,(q-1)\}) \\
= C_{q \mid  r < q}(\svec,\uvec); \quad \svec,\uvec \in \mathbb{R}^d,\\
\end{align}
$$
where $\{b_{qr}(\cdot,\cdot) : r = 1,\dots,(q-1) ;~q = 2,\dots,p\}$ are integrable.
</small>

## Is the multivariate model always valid? {.smaller .build}

- Proof by induction
    - We know that $J_2 > 0$
    - Assume $J_{p-1} > 0$.
    - Show $J_p > 0$.
                                                                                               
$$
J_p= \sum_{m=1}^{n_p}\sum_{m'=1}^{n_p}a_{pm}a_{pm'}C_{p \mid  (q < p)}(\svec_{pm},\svec_{pm'}) 
$$
$$
~~~~~~~+ \sum_{q=1}^{p-1}\sum_{r=1}^{p-1}\int_D\int_Da_q(\svec)a_r(\uvec)C_{qr}(\svec,\uvec)\intd \svec \intd \uvec,   
$$
where
$$                                                                                               
a_q(\svec) \equiv \left(\sum_{k=1}^{n_q}a_{qk}\delta(\svec - \svec_{qk}) + \sum_{m=1}^{n_p}a_{pm}b_{pq}(\svec_{pm},\svec)\right).
$$


## Generalisations

The following can all be shown to be special cases of causal spatial models

- The parsimonious Matern model of @Gneitingetal2010
- The full Matern model of @Gneitingetal2010
- The linear model of coregionalsiation @Wackernagel1995
- The moving average model of @verHoef_1998

## Graphical structure

\begin{figure}[!t]
\begin{center}
\begin{tikzpicture}[scale=1,every node/.style={transform shape}]
%[inner sep=1mm]                                                                                                                                                                                               
[line width=2pt]
\draw (0,0) node(psib) {$\left. \begin{array}{l}  \psi \\ ~ \\ BC \en{darray} \right\}$};
\draw (2,0) node(xM) {$x$};
\draw (4,0) node(x) {$z$};
\draw (5.5,0) node(z) {$z$};
\draw (3,1) node(thetab) {$\theta$};
\draw (1.2,0.3) node(g) {$g(\cdot)$};

\draw [->] (thetab) to (xM);
\draw [->] (thetab) to (x);
\draw [->] (psib) to (xM);
\draw [->] (x) to (z);


\end{tikzpicture}
\caption{Assumed .}\label{fig:exchangeable}
\end{center}
\end{figure}


Chains
Not limited to chains
Number of free functions = number of elements in CCFM

# References

## References {.smaller}